name: Release Build and Deploy

on:
  push:
    tags:
      - 'v*.*.*'  # v0.0.1, v1.2.3 ë“±ì˜ íƒœê·¸ê°€ í‘¸ì‹œë  ë•Œ ì‹¤í–‰
    branches:
      - main  # main ë¸Œëœì¹˜ì—ì„œë§Œ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

permissions:
  contents: write  # Release ìƒì„± ê¶Œí•œ ëª…ì‹œì  ë¶€ì—¬

jobs:
  release:
    name: Create Release
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Extract version from tag
      id: get_version
      shell: pwsh
      run: |
        if ("${{ github.ref }}" -match "refs/tags/v(.+)") {
          $version = $matches[1]
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "tag_name=v$version" >> $env:GITHUB_OUTPUT
        } else {
          $version = "0.1.0"
          echo "version=$version" >> $env:GITHUB_OUTPUT  
          echo "tag_name=v$version" >> $env:GITHUB_OUTPUT
        }
        echo "Extracted version: $version"
        
    - name: Update project version
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $csprojPath = "TarkovClient.csproj"
        
        # .csproj íŒŒì¼ì˜ ë²„ì „ ì—…ë°ì´íŠ¸
        $content = Get-Content $csprojPath -Raw
        $content = $content -replace '<Version>[\d\.]+</Version>', "<Version>$version</Version>"
        $content = $content -replace '<FileVersion>[\d\.]+</FileVersion>', "<FileVersion>$version</FileVersion>"
        $content = $content -replace '<AssemblyVersion>[\d\.]+</AssemblyVersion>', "<AssemblyVersion>$version</AssemblyVersion>"
        Set-Content -Path $csprojPath -Value $content -Encoding UTF8
        
        # ì‚¬ìš©ë²•.txt íŒŒì¼ì˜ ë²„ì „ ì—…ë°ì´íŠ¸
        if (Test-Path "ì‚¬ìš©ë²•.txt") {
          $usageContent = Get-Content "ì‚¬ìš©ë²•.txt" -Raw -Encoding UTF8
          $usageContent = $usageContent -replace 'Tarkov Client v[\d\.]+', "Tarkov Client v$version"
          Set-Content -Path "ì‚¬ìš©ë²•.txt" -Value $usageContent -Encoding UTF8
        }
        
        echo "Updated version to: $version"
        
    - name: Set PowerShell execution policy
      shell: pwsh
      run: Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
      
    - name: Build publish version
      shell: pwsh
      run: |
        Write-Host "Building Self-Contained executable..." -ForegroundColor Green
        & "scripts\build-publish.ps1"
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Build failed!" -ForegroundColor Red
          exit $LASTEXITCODE
        }
        
    - name: Create package
      shell: pwsh
      run: |
        Write-Host "Creating release package..." -ForegroundColor Green
        & "scripts\create-package.ps1"
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Package creation failed!" -ForegroundColor Red
          exit $LASTEXITCODE
        }
        
    - name: Build installer (optional)
      shell: pwsh
      run: |
        # Inno Setupì´ ì„¤ì¹˜ë˜ì–´ ìˆìœ¼ë©´ ì„¤ì¹˜ í”„ë¡œê·¸ë¨ë„ ìƒì„±
        if (Get-Command "iscc" -ErrorAction SilentlyContinue) {
          Write-Host "Building Windows installer..." -ForegroundColor Green
          & "setup\build-installer.ps1"
        } else {
          Write-Host "Inno Setup not found. Skipping installer build." -ForegroundColor Yellow
        }
      continue-on-error: true
      
    - name: Check for installer file
      id: check_installer
      shell: pwsh
      run: |
        if (Test-Path "setup/Output/TarkovClientSetup.exe") {
          echo "installer_exists=true" >> $env:GITHUB_OUTPUT
          Write-Host "Installer found and will be included in release" -ForegroundColor Green
        } else {
          echo "installer_exists=false" >> $env:GITHUB_OUTPUT
          Write-Host "Installer not found, skipping" -ForegroundColor Yellow
        }
        
    - name: Create Release with installer
      if: steps.check_installer.outputs.installer_exists == 'true'
      uses: softprops/action-gh-release@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        name: 'Tarkov Client ${{ steps.get_version.outputs.version }}'
        files: |
          TarkovClient-${{ steps.get_version.outputs.tag_name }}.zip
          setup/Output/TarkovClientSetup.exe
        body: |
          ## ğŸ¯ Tarkov Client ${{ steps.get_version.outputs.version }}
          
          > Tarkov Market Pilotì„ ìœ„í•œ ì „ìš© ë°ìŠ¤í¬í†± ì• í”Œë¦¬ì¼€ì´ì…˜
          
          ### ğŸ“¥ ë‹¤ìš´ë¡œë“œ
          
          **í¬í„°ë¸” ë²„ì „ (ê¶Œì¥)**:
          - `TarkovClient-${{ steps.get_version.outputs.tag_name }}.zip` - ì••ì¶• í•´ì œ í›„ ë°”ë¡œ ì‹¤í–‰
          - í¬í•¨: TarkovClient.exe + ì‚¬ìš©ë²•.txt (í•œê¸€ ê°€ì´ë“œ)
          
          **ì„¤ì¹˜ í”„ë¡œê·¸ë¨**:
          - `TarkovClientSetup.exe` - ìë™ ì„¤ì¹˜ ë° ë°”ë¡œê°€ê¸° ìƒì„±
          
          ### âš¡ ì£¼ìš” ê¸°ëŠ¥
          - âœ… Self-Contained ë°°í¬ - .NET Runtime ì„¤ì¹˜ ë¶ˆí•„ìš”
          - âœ… ì‹¤ì‹œê°„ ë§µ ê°ì§€ - ê²Œì„ ë¡œê·¸ ê¸°ë°˜ ìë™ ê°ì§€
          - âœ… ìŠ¤í¬ë¦°ìƒ· ì¶”ì  - F12 ê¸°ë°˜ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
          - âœ… ìë™ ì„¸ì…˜ ì •ë¦¬ - ê²Œì„ ì¢…ë£Œ ì‹œ ë¡œê·¸ ì •ë¦¬
          
          ### ğŸ–¥ï¸ ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­
          - Windows 10/11 (64ë¹„íŠ¸)
          - WebView2 Runtime (Windows ì—…ë°ì´íŠ¸ë¡œ ì„¤ì¹˜)
          
          ### âš ï¸ Windows Defender ê²½ê³ 
          ì²˜ìŒ ì‹¤í–‰ ì‹œ ë³´ì•ˆ ê²½ê³ ê°€ ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          "ì¶”ê°€ ì •ë³´" â†’ "ì‹¤í–‰" í´ë¦­ìœ¼ë¡œ í•´ê²°í•˜ì„¸ìš”.
          
          ### ğŸ”— ë¬¸ì˜
          - ì¹´ì¹´ì˜¤í†¡: https://open.kakao.com/o/sEeL0LNh
          - GitHub Issues: ê¸°ìˆ ì  ë¬¸ì˜ ë° ë²„ê·¸ ë¦¬í¬íŠ¸
        draft: false
        prerelease: false
        
    - name: Create Release without installer
      if: steps.check_installer.outputs.installer_exists != 'true'
      uses: softprops/action-gh-release@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        name: 'Tarkov Client ${{ steps.get_version.outputs.version }}'
        files: |
          TarkovClient-${{ steps.get_version.outputs.tag_name }}.zip
        body: |
          ## ğŸ¯ Tarkov Client ${{ steps.get_version.outputs.version }}
          
          > Tarkov Market Pilotì„ ìœ„í•œ ì „ìš© ë°ìŠ¤í¬í†± ì• í”Œë¦¬ì¼€ì´ì…˜
          
          ### ğŸ“¥ ë‹¤ìš´ë¡œë“œ
          
          **í¬í„°ë¸” ë²„ì „ (ê¶Œì¥)**:
          - `TarkovClient-${{ steps.get_version.outputs.tag_name }}.zip` - ì••ì¶• í•´ì œ í›„ ë°”ë¡œ ì‹¤í–‰
          - í¬í•¨: TarkovClient.exe + ì‚¬ìš©ë²•.txt (í•œê¸€ ê°€ì´ë“œ)
          
          ### âš¡ ì£¼ìš” ê¸°ëŠ¥
          - âœ… Self-Contained ë°°í¬ - .NET Runtime ì„¤ì¹˜ ë¶ˆí•„ìš”
          - âœ… ì‹¤ì‹œê°„ ë§µ ê°ì§€ - ê²Œì„ ë¡œê·¸ ê¸°ë°˜ ìë™ ê°ì§€
          - âœ… ìŠ¤í¬ë¦°ìƒ· ì¶”ì  - F12 ê¸°ë°˜ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
          - âœ… ìë™ ì„¸ì…˜ ì •ë¦¬ - ê²Œì„ ì¢…ë£Œ ì‹œ ë¡œê·¸ ì •ë¦¬
          
          ### ğŸ–¥ï¸ ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­
          - Windows 10/11 (64ë¹„íŠ¸)
          - WebView2 Runtime (Windows ì—…ë°ì´íŠ¸ë¡œ ì„¤ì¹˜)
          
          ### âš ï¸ Windows Defender ê²½ê³ 
          ì²˜ìŒ ì‹¤í–‰ ì‹œ ë³´ì•ˆ ê²½ê³ ê°€ ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          "ì¶”ê°€ ì •ë³´" â†’ "ì‹¤í–‰" í´ë¦­ìœ¼ë¡œ í•´ê²°í•˜ì„¸ìš”.
          
          ### ğŸ”— ë¬¸ì˜
          - ì¹´ì¹´ì˜¤í†¡: https://open.kakao.com/o/sEeL0LNh
          - GitHub Issues: ê¸°ìˆ ì  ë¬¸ì˜ ë° ë²„ê·¸ ë¦¬í¬íŠ¸
        draft: false
        prerelease: false