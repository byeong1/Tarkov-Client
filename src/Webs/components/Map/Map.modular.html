<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÌÉÄÎ•¥ÏΩîÌîÑ ÏßÄÎèÑ (Tarkov Map) - Modular</title>
    
    <!-- Leaflet.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Î™®ÎìàÌôîÎêú Map CSS -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/panels.css">
    <link rel="stylesheet" href="css/controls.css">
    <link rel="stylesheet" href="css/loading.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <!-- ÏßÄÎèÑ Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà -->
    <div id="tarkov-map-container" class="map-container">
        <!-- ÏÉÅÎã® Ïª®Ìä∏Î°§ Î∞î -->
        <div id="panel_top" class="panel-top">
            <div class="top-controls">
                <div class="level-selector">
                    <select id="levelSelector">
                        <option value="main">Ground Floor</option>
                    </select>
                </div>
                <button class="top-btn" data-action="refresh" title="Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®">
                    üîÑ Refresh
                </button>
                <button class="top-btn" data-action="toggle-panels" title="Ìå®ÎÑê ÌÜ†Í∏Ä">
                    üìã Panels
                </button>
                <button class="top-btn" data-action="settings" title="ÏÑ§Ï†ï">
                    ‚öôÔ∏è Settings
                </button>
                <button class="top-btn" data-action="fullscreen" title="Ï†ÑÏ≤¥ÌôîÎ©¥">
                    üî≥ Fullscreen
                </button>
            </div>
        </div>
        
        <!-- ÏßÄÎèÑ ÏòÅÏó≠ -->
        <div id="map" class="leaflet-map"></div>
        
        <!-- ÏôºÏ™Ω Ìå®ÎÑê (ÎßàÏª§ ÌïÑÌÑ∞) -->
        <div id="panel_left" class="panel-left">
            <div class="panel-toggle" title="Ìå®ÎÑê ÌÜ†Í∏Ä">‚óÄ</div>
            <div class="panel-header">
                <h2 class="panel-title">Markers</h2>
                <div class="panel-subtitle">Ïä§Ìè∞ Ìè¨Ïù∏Ìä∏ Î∞è ÎßàÏª§</div>
            </div>
            <div class="panel-content" id="panel_left_content">
                <!-- MarkerFilterPanelÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ± -->
                <div class="filter-controls">
                    <div class="search-box">
                        <input type="text" class="search-input" placeholder="ÎßàÏª§ Í≤ÄÏÉâ..." />
                        <div class="search-icon">üîç</div>
                    </div>
                </div>
                
                <div class="panel-section expanded">
                    <div class="panel-section-header">
                        <h3 class="panel-section-title">Spawn Points</h3>
                        <div class="panel-section-toggle">‚ñ∂</div>
                    </div>
                    <div class="panel-section-content">
                        <div class="tree-container">
                            <!-- ÎèôÏ†ÅÏúºÎ°ú ÎßàÏª§ Ìä∏Î¶¨ ÏÉùÏÑ± -->
                            <div class="loading-skeleton">
                                <div class="skeleton skeleton-title"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel-section">
                    <div class="panel-section-header">
                        <h3 class="panel-section-title">Extract Points</h3>
                        <div class="panel-section-toggle">‚ñ∂</div>
                    </div>
                    <div class="panel-section-content">
                        <div class="tree-container">
                            <div class="loading-skeleton">
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel-footer">
                <div class="panel-stats">
                    Ï¥ù <span id="marker-count">--</span>Í∞ú ÎßàÏª§
                </div>
            </div>
        </div>
        
        <!-- Ïò§Î•∏Ï™Ω Ìå®ÎÑê (ÌÄòÏä§Ìä∏ ÌïÑÌÑ∞) -->
        <div id="panel_right" class="panel-right">
            <div class="panel-toggle" title="Ìå®ÎÑê ÌÜ†Í∏Ä">‚ñ∂</div>
            <div class="panel-header">
                <h2 class="panel-title">Quests</h2>
                <div class="panel-subtitle">ÌÄòÏä§Ìä∏ Î™©Ìëú Î∞è ÏïÑÏù¥ÌÖú</div>
            </div>
            <div class="panel-content" id="panel_right_content">
                <!-- QuestFilterPanelÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ± -->
                <div class="filter-controls">
                    <div class="search-box">
                        <input type="text" class="search-input" placeholder="ÌÄòÏä§Ìä∏ Í≤ÄÏÉâ..." />
                        <div class="search-icon">üîç</div>
                    </div>
                </div>
                
                <div class="panel-section expanded">
                    <div class="panel-section-header">
                        <h3 class="panel-section-title">Active Quests</h3>
                        <div class="panel-section-toggle">‚ñ∂</div>
                    </div>
                    <div class="panel-section-content">
                        <div class="tree-container">
                            <div class="loading-skeleton">
                                <div class="skeleton skeleton-title"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel-section">
                    <div class="panel-section-header">
                        <h3 class="panel-section-title">Quest Items</h3>
                        <div class="panel-section-toggle">‚ñ∂</div>
                    </div>
                    <div class="panel-section-content">
                        <div class="tree-container">
                            <div class="loading-skeleton">
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel-footer">
                <div class="panel-stats">
                    Ï¥ù <span id="quest-count">--</span>Í∞ú ÌÄòÏä§Ìä∏
                </div>
            </div>
        </div>
        
        <!-- Ï¢åÌëú ÌëúÏãú -->
        <div class="coordinate-display">
            Lat: --, Lng: --
        </div>
        
        <!-- Ï§å Ï†ïÎ≥¥ -->
        <div class="zoom-info">
            Zoom: <span id="zoom-level">0</span>
        </div>
        
        <!-- ÏßÄÎèÑ ÌÜµÍ≥Ñ -->
        <div class="map-stats">
            <div class="stat-item">
                <div class="stat-icon marker-spawn"></div>
                <span id="spawn-count">0</span>
            </div>
            <div class="stat-item">
                <div class="stat-icon marker-extract"></div>
                <span id="extract-count">0</span>
            </div>
            <div class="stat-item">
                <div class="stat-icon marker-quest"></div>
                <span id="quest-marker-count">0</span>
            </div>
        </div>
        
        <!-- Î°úÎî© Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ -->
        <div id="loading-indicator" class="loading-indicator">
            <div class="loading-spinner"></div>
            <div class="loading-text">ÏßÄÎèÑ Î°úÎî© Ï§ë...</div>
        </div>
        
        <!-- ÏóêÎü¨ Î©îÏãúÏßÄ -->
        <div id="error-message" class="error-message">
            <div class="error-icon">‚ö†Ô∏è</div>
            <div class="error-text"></div>
            <button class="error-close">&times;</button>
        </div>
    </div>

    <!-- Leaflet.js JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Leaflet Rotated Marker Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.min.js"></script>
    
    <!-- Î™®ÎìàÌôîÎêú JavaScript ÏãúÏä§ÌÖú -->
    <!-- 1. Core Event System -->
    <script src="js/core/EventBus.js"></script>
    
    <!-- 2. Core Data & UI Managers -->
    <script src="js/core/DataLoader.js"></script>
    <script src="js/managers/UIManager.js"></script>
    
    <!-- 3. Legacy Systems (Í∏∞Ï°¥ Ìò∏ÌôòÏÑ±) -->
    <script src="TarkovMapSystem.js"></script>
    <script src="TarkovDevAPI.js"></script>
    <script src="MarkerManager.js"></script>
    <script src="MarkerFilterPanel.js"></script>
    <script src="QuestFilterPanel.js"></script>
    <script src="CoordinateSystem.js"></script>
    
    <!-- 4. Main Application (Refactored) -->
    <script src="Map.refactored.js"></script>
    
    <script>
        // C#ÏóêÏÑú Ìò∏Ï∂ú Í∞ÄÎä•Ìïú Ï†ÑÏó≠ Í∞ùÏ≤¥ Ï¥àÍ∏∞Ìôî
        window.tarkovMap = null;
        window.tarkovMapApp = null;

        // ÎîîÎ≤ÑÍ∑∏ Î™®Îìú ÌôúÏÑ±Ìôî (Í∞úÎ∞ú Ï§ë)
        if (window.eventBus) {
            window.eventBus.setDebugMode(true);
            console.log('üêõ EventBus ÎîîÎ≤ÑÍ∑∏ Î™®Îìú ÌôúÏÑ±Ìôî');
        }

        // DOM Î°úÎî© ÏôÑÎ£å ÌõÑ ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('üöÄ Î™®ÎìàÌôîÎêú ÏßÄÎèÑ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî ÏãúÏûë...');
                
                // EventBus ÏÉÅÌÉú ÌôïÏù∏
                if (!window.eventBus) {
                    throw new Error('EventBusÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§');
                }
                
                // ÏßÄÎèÑ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ï¥àÍ∏∞Ìôî (Î¶¨Ìå©ÌÜ†ÎßÅÎêú Î≤ÑÏ†Ñ)
                window.tarkovMapApp = new TarkovMapApplication('tarkov-map-container');
                
                // Ï¥àÍ∏∞Ìôî ÏôÑÎ£å ÎåÄÍ∏∞
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî ÌÉÄÏûÑÏïÑÏõÉ (10Ï¥à)'));
                    }, 10000);

                    const checkInit = () => {
                        if (window.tarkovMapApp?.isInitialized) {
                            clearTimeout(timeout);
                            resolve();
                        } else {
                            setTimeout(checkInit, 100);
                        }
                    };
                    checkInit();
                });

                console.log('‚úÖ Î™®ÎìàÌôîÎêú ÏßÄÎèÑ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
                
                // EventBus ÌÜµÍ≥Ñ Ï∂úÎ†•
                if (window.eventBus) {
                    console.log('üìä EventBus ÌÜµÍ≥Ñ:', window.eventBus.getStats());
                }
                
                // C#Ïóê Ï¥àÍ∏∞Ìôî ÏôÑÎ£å ÏïåÎ¶º
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage(JSON.stringify({
                        type: 'MAP_READY',
                        version: 'modular',
                        timestamp: Date.now(),
                        modules: {
                            eventBus: !!window.eventBus,
                            dataLoader: !!window.tarkovMapApp?.dataLoader,
                            uiManager: !!window.tarkovMapApp?.uiManager
                        }
                    }));
                }

                // Í∞úÎ∞úÏö© Ï†ÑÏó≠ Ï†ëÍ∑º
                window.$debug = {
                    app: window.tarkovMapApp,
                    eventBus: window.eventBus,
                    dataLoader: window.tarkovMapApp?.dataLoader,
                    uiManager: window.tarkovMapApp?.uiManager,
                    showEventHistory: () => window.eventBus.getHistory(),
                    showStats: () => window.eventBus.getStats()
                };

            } catch (error) {
                console.error('‚ùå Î™®ÎìàÌôîÎêú ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                
                // Ïò§Î•ò Î©îÏãúÏßÄ ÌëúÏãú
                showError('ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî Ïã§Ìå®: ' + error.message);
                
                // C#Ïóê Ïò§Î•ò ÏïåÎ¶º
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage(JSON.stringify({
                        type: 'MAP_ERROR',
                        version: 'modular',
                        data: {
                            message: error.message,
                            source: 'modular_initialization',
                            timestamp: Date.now()
                        }
                    }));
                }
            }
        });

        // Ïò§Î•ò Î©îÏãúÏßÄ ÌëúÏãú Ìï®Ïàò
        const showError = (message) => {
            const errorElement = document.getElementById('error-message');
            const errorText = errorElement.querySelector('.error-text');
            const loadingElement = document.getElementById('loading-indicator');
            
            if (loadingElement) loadingElement.style.display = 'none';
            if (errorText) errorText.textContent = message;
            if (errorElement) errorElement.style.display = 'flex';
        };

        // ÏóêÎü¨ Î©îÏãúÏßÄ Îã´Í∏∞
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('error-close')) {
                const errorElement = document.getElementById('error-message');
                if (errorElement) errorElement.style.display = 'none';
            }
        });

        // C#ÏóêÏÑú WebView2 Î©îÏãúÏßÄ ÏàòÏã† Ï≤òÎ¶¨
        if (window.chrome && window.chrome.webview) {
            window.chrome.webview.addEventListener('message', (event) => {
                try {
                    const message = JSON.parse(event.data);
                    
                    if (window.tarkovMapApp && window.tarkovMapApp.isInitialized) {
                        window.tarkovMapApp.handleWebViewMessage(message);
                    } else {
                        console.warn('‚ö†Ô∏è ÏßÄÎèÑ ÏãúÏä§ÌÖúÏù¥ ÏïÑÏßÅ Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏùå:', message);
                        
                        // Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞ Ï§ëÏù∏ Î©îÏãúÏßÄÎäî EventBusÏóê ÏûÑÏãú Ï†ÄÏû•
                        if (window.eventBus) {
                            window.eventBus.emit('webview:message:pending', message);
                        }
                    }
                } catch (error) {
                    console.error('‚ùå WebView Î©îÏãúÏßÄ Ï≤òÎ¶¨ Ïò§Î•ò:', error, event.data);
                }
            });
        }

        // Í∞úÎ∞úÏö© Îã®Ï∂ïÌÇ§
        if (process?.env?.NODE_ENV === 'development') {
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.shiftKey) {
                    switch (e.key) {
                        case 'D':
                            // EventBus ÎîîÎ≤ÑÍ∑∏ Î™®Îìú ÌÜ†Í∏Ä
                            const debugMode = !window.eventBus.debugMode;
                            window.eventBus.setDebugMode(debugMode);
                            console.log(`üêõ EventBus ÎîîÎ≤ÑÍ∑∏ Î™®Îìú: ${debugMode ? 'ÌôúÏÑ±Ìôî' : 'ÎπÑÌôúÏÑ±Ìôî'}`);
                            e.preventDefault();
                            break;
                        case 'S':
                            // EventBus ÌÜµÍ≥Ñ Ï∂úÎ†•
                            console.table(window.eventBus.getStats());
                            e.preventDefault();
                            break;
                        case 'H':
                            // EventBus Ïù¥Î≤§Ìä∏ ÌûàÏä§ÌÜ†Î¶¨ Ï∂úÎ†•
                            console.table(window.eventBus.getHistory());
                            e.preventDefault();
                            break;
                    }
                }
            });
        }
    </script>
</body>
</html>