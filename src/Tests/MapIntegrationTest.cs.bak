using System;
using System.Threading.Tasks;
using System.IO;
using System.Windows;
using TarkovClient;
using Microsoft.Web.WebView2.Wpf;

namespace TarkovClient.Tests
{
    /// <summary>
    /// ì§€ë„ ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤
    /// MapViewControllerì™€ PositionParserì˜ í†µí•© ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸
    /// </summary>
    public class MapIntegrationTest
    {
        private MapViewController _mapController;
        private WebView2 _webView;
        private bool _testsPassed = true;
        private int _totalTests = 0;
        private int _passedTests = 0;

        /// <summary>
        /// í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        /// </summary>
        public async Task<bool> RunIntegrationTests()
        {
            Console.WriteLine("=== íƒ€ë¥´ì½”í”„ ì§€ë„ ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸ ì‹œì‘ ===");
            Console.WriteLine();

            try
            {
                // í…ŒìŠ¤íŠ¸ í™˜ê²½ ì´ˆê¸°í™”
                await InitializeTestEnvironment();

                // í•µì‹¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                await TestPositionParsing();
                await TestCoordinateTransformation();
                await TestMapViewController();
                await TestWebViewCommunication();
                await TestPositionUpdates();
                await TestMapSwitching();
                await TestErrorHandling();

                // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¶œë ¥
                PrintTestResults();

                return _testsPassed;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"âŒ í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {ex.Message}");
                return false;
            }
            finally
            {
                // í…ŒìŠ¤íŠ¸ í™˜ê²½ ì •ë¦¬
                CleanupTestEnvironment();
            }
        }

        /// <summary>
        /// í…ŒìŠ¤íŠ¸ í™˜ê²½ ì´ˆê¸°í™”
        /// </summary>
        private async Task InitializeTestEnvironment()
        {
            Console.WriteLine("ğŸ”§ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì´ˆê¸°í™” ì¤‘...");

            try
            {
                // WebView2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (í…ŒìŠ¤íŠ¸ìš©)
                _webView = new WebView2();

                // MapViewController ìƒì„± ë° ì´ˆê¸°í™”
                _mapController = new MapViewController(_webView);

                Console.WriteLine("âœ… í…ŒìŠ¤íŠ¸ í™˜ê²½ ì´ˆê¸°í™” ì™„ë£Œ");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"âŒ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì´ˆê¸°í™” ì‹¤íŒ¨: {ex.Message}");
                throw;
            }
        }

        /// <summary>
        /// ìœ„ì¹˜ íŒŒì‹± í…ŒìŠ¤íŠ¸
        /// </summary>
        private async Task TestPositionParsing()
        {
            Console.WriteLine("\nğŸ“ ìœ„ì¹˜ íŒŒì‹± í…ŒìŠ¤íŠ¸");
            Console.WriteLine("====================");

            // í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì •ì˜
            var testCases = new[]
            {
                new { 
                    Filename = "2024-08-27[15-30]_FactoryDay_-25.8_-18.2_5.1_0.0_-0.7_0.0_0.7 (1).png",
                    ExpectedMap = "FactoryDay",
                    ExpectedX = -25.8f,
                    ExpectedZ = -18.2f
                },
                new { 
                    Filename = "2024-08-27[10-15]_Customs_100.5_-200.3_10.0_0.1_0.0_0.5_0.8.png",
                    ExpectedMap = "Customs", 
                    ExpectedX = 100.5f,
                    ExpectedZ = -200.3f
                },
                new { 
                    Filename = "invalid_filename.png",
                    ExpectedMap = (string)null,
                    ExpectedX = 0f,
                    ExpectedZ = 0f
                }
            };

            foreach (var testCase in testCases)
            {
                await TestCase($"íŒŒì‹± í…ŒìŠ¤íŠ¸: {Path.GetFileName(testCase.Filename)}", () =>
                {
                    var result = PositionParser.ParseFromFilename(testCase.Filename);
                    
                    if (testCase.ExpectedMap == null)
                    {
                        // null ì˜ˆìƒ (ì‹¤íŒ¨ ì¼€ì´ìŠ¤)
                        return result == null;
                    }
                    else
                    {
                        // ì„±ê³µ ì¼€ì´ìŠ¤
                        return result != null &&
                               result.MapName == testCase.ExpectedMap &&
                               Math.Abs(result.X - testCase.ExpectedX) < 0.01f &&
                               Math.Abs(result.Z - testCase.ExpectedZ) < 0.01f;
                    }
                });
            }
        }

        /// <summary>
        /// ì¢Œí‘œ ë³€í™˜ í…ŒìŠ¤íŠ¸
        /// </summary>
        private async Task TestCoordinateTransformation()
        {
            Console.WriteLine("\nğŸ—ºï¸ ì¢Œí‘œ ë³€í™˜ í…ŒìŠ¤íŠ¸");
            Console.WriteLine("====================");

            // ê¸°ë³¸ ì¢Œí‘œ ë³€í™˜ í…ŒìŠ¤íŠ¸
            await TestCase("ê¸°ë³¸ ì¢Œí‘œ ë³€í™˜", () =>
            {
                var position = new Position
                {
                    MapName = "factory",
                    X = 10.0f,
                    Z = -15.0f,
                    Y = 5.0f
                };

                // ë³€í™˜ ê²°ê³¼ í™•ì¸ (êµ¬ì²´ì ì¸ ê°’ì€ ì¢Œí‘œ ì‹œìŠ¤í…œ ì„¤ì •ì— ë”°ë¼ ë‹¬ë¼ì§)
                return position.X == 10.0f && position.Z == -15.0f;
            });

            // ì¿¼í„°ë‹ˆì–¸ íšŒì „ ê³„ì‚° í…ŒìŠ¤íŠ¸
            await TestCase("ì¿¼í„°ë‹ˆì–¸ â†’ Yaw ë³€í™˜", () =>
            {
                var position = new Position
                {
                    MapName = "factory",
                    X = 0, Z = 0, Y = 0,
                    QuaternionX = 0.0f,
                    QuaternionY = -0.7071068f, // 90ë„ íšŒì „
                    QuaternionZ = 0.0f,
                    QuaternionW = 0.7071068f
                };

                var yaw = position.Rotation;
                // 90ë„ íšŒì „ (Â±5ë„ ì˜¤ì°¨ í—ˆìš©)
                return Math.Abs(yaw - 90.0f) < 5.0f || Math.Abs(yaw + 90.0f) < 5.0f;
            });
        }

        /// <summary>
        /// MapViewController í…ŒìŠ¤íŠ¸
        /// </summary>
        private async Task TestMapViewController()
        {
            Console.WriteLine("\nğŸ® MapViewController í…ŒìŠ¤íŠ¸");
            Console.WriteLine("==============================");

            await TestCase("MapViewController ì´ˆê¸°í™”", () =>
            {
                return _mapController != null;
            });

            // WebView2ê°€ ì‹¤ì œ í™˜ê²½ì—ì„œë§Œ ë™ì‘í•˜ë¯€ë¡œ ê¸°ë³¸ ê²€ì¦ë§Œ ìˆ˜í–‰
            await TestCase("MapViewController ìƒíƒœ í™•ì¸", () =>
            {
                return _mapController.CurrentMapId != null; // ì´ˆê¸° ìƒíƒœ í™•ì¸
            });
        }

        /// <summary>
        /// WebView í†µì‹  í…ŒìŠ¤íŠ¸
        /// </summary>
        private async Task TestWebViewCommunication()
        {
            Console.WriteLine("\nğŸ’¬ WebView í†µì‹  í…ŒìŠ¤íŠ¸");
            Console.WriteLine("========================");

            // ë©”ì‹œì§€ ìƒì„± ë° ì§ë ¬í™” í…ŒìŠ¤íŠ¸
            await TestCase("WebView ë©”ì‹œì§€ ì§ë ¬í™”", () =>
            {
                var message = new WebViewMessage("TEST_MESSAGE", new { test = "data" });
                var json = message.ToJson();
                
                return !string.IsNullOrEmpty(json) && json.Contains("TEST_MESSAGE");
            });

            // ë©”ì‹œì§€ ì—­ì§ë ¬í™” í…ŒìŠ¤íŠ¸
            await TestCase("WebView ë©”ì‹œì§€ ì—­ì§ë ¬í™”", () =>
            {
                var json = "{\"type\":\"TEST\",\"data\":{\"value\":123},\"id\":\"test-id\",\"timestamp\":1234567890,\"source\":\"test\"}";
                var message = WebViewMessage.FromJson(json);
                
                return message != null && 
                       message.Type == "TEST" && 
                       message.Id == "test-id";
            });

            // ë©”ì‹œì§€ ê²€ì¦ í…ŒìŠ¤íŠ¸
            await TestCase("WebView ë©”ì‹œì§€ ê²€ì¦", () =>
            {
                var validMessage = new WebViewMessage("VALID_TYPE", new { });
                var invalidMessage = new WebViewMessage("", new { });
                invalidMessage.Id = "";

                return WebViewMessageValidator.IsValid(validMessage) && 
                       !WebViewMessageValidator.IsValid(invalidMessage);
            });
        }

        /// <summary>
        /// ìœ„ì¹˜ ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸
        /// </summary>
        private async Task TestPositionUpdates()
        {
            Console.WriteLine("\nğŸ“Š ìœ„ì¹˜ ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸");
            Console.WriteLine("========================");

            await TestCase("Position ê°ì²´ ìƒì„±", () =>
            {
                var position = new Position
                {
                    MapName = "factory",
                    X = 10.5f,
                    Y = 5.0f,
                    Z = -20.3f,
                    QuaternionX = 0.0f,
                    QuaternionY = 0.707f,
                    QuaternionZ = 0.0f,
                    QuaternionW = 0.707f,
                    Timestamp = DateTime.Now,
                    Accuracy = 1.0f
                };

                return position.MapName == "factory" &&
                       Math.Abs(position.X - 10.5f) < 0.01f &&
                       position.Rotation > 0; // ì¿¼í„°ë‹ˆì–¸ ê³„ì‚° ê²°ê³¼ í™•ì¸
            });

            await TestCase("PositionUpdateData ë³€í™˜", () =>
            {
                var position = new Position
                {
                    MapName = "customs",
                    X = -50.0f,
                    Y = 10.0f,
                    Z = 100.0f,
                    Timestamp = DateTime.Now
                };

                var updateData = PositionUpdateData.FromPosition(position);
                
                return updateData.MapId == "customs" &&
                       Math.Abs(updateData.X - (-50.0f)) < 0.01f &&
                       Math.Abs(updateData.Z - 100.0f) < 0.01f;
            });
        }

        /// <summary>
        /// ë§µ ì „í™˜ í…ŒìŠ¤íŠ¸
        /// </summary>
        private async Task TestMapSwitching()
        {
            Console.WriteLine("\nğŸ”„ ë§µ ì „í™˜ í…ŒìŠ¤íŠ¸");
            Console.WriteLine("==================");

            await TestCase("ë§µ ì„¤ì • ë°ì´í„°", () =>
            {
                var settings = new MapSettingsData
                {
                    Theme = "dark",
                    ShowGrid = true,
                    ShowDirection = true,
                    MarkerSize = 16,
                    UpdateInterval = 50
                };

                return settings.Theme == "dark" &&
                       settings.ShowGrid &&
                       settings.MarkerSize == 16;
            });

            await TestCase("ë§µ ë³€ê²½ ë°ì´í„°", () =>
            {
                var mapChange = new WebViewMapChangeData
                {
                    MapId = "shoreline",
                    DisplayName = "Shoreline"
                };

                return mapChange.MapId == "shoreline" &&
                       mapChange.DisplayName == "Shoreline";
            });
        }

        /// <summary>
        /// ì˜¤ë¥˜ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
        /// </summary>
        private async Task TestErrorHandling()
        {
            Console.WriteLine("\nâš ï¸ ì˜¤ë¥˜ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸");
            Console.WriteLine("====================");

            await TestCase("ì˜¤ë¥˜ ë¦¬í¬íŠ¸ ë°ì´í„°", () =>
            {
                var error = new ErrorReportData
                {
                    Message = "í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜",
                    Source = "test",
                    Severity = "error"
                };

                return error.Message == "í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜" &&
                       error.Source == "test" &&
                       error.Severity == "error";
            });

            await TestCase("ì˜ëª»ëœ ìœ„ì¹˜ íŒŒì‹± ì²˜ë¦¬", () =>
            {
                var result = PositionParser.ParseFromFilename("invalid_file.txt");
                return result == null; // null ë°˜í™˜ì´ ì˜ˆìƒë¨
            });

            await TestCase("ë¹ˆ íŒŒì¼ëª… ì²˜ë¦¬", () =>
            {
                var result = PositionParser.ParseFromFilename("");
                return result == null;
            });

            await TestCase("null íŒŒì¼ëª… ì²˜ë¦¬", () =>
            {
                var result = PositionParser.ParseFromFilename(null);
                return result == null;
            });
        }

        /// <summary>
        /// ê°œë³„ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‹¤í–‰
        /// </summary>
        private async Task TestCase(string testName, Func<bool> testFunc)
        {
            _totalTests++;
            
            try
            {
                Console.Write($"  {testName}... ");
                
                var result = testFunc();
                
                if (result)
                {
                    Console.WriteLine("âœ… í†µê³¼");
                    _passedTests++;
                }
                else
                {
                    Console.WriteLine("âŒ ì‹¤íŒ¨");
                    _testsPassed = false;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"âŒ ì˜ˆì™¸: {ex.Message}");
                _testsPassed = false;
            }
            
            await Task.Delay(10); // UI ìŠ¤ë ˆë“œ ì–‘ë³´
        }

        /// <summary>
        /// í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¶œë ¥
        /// </summary>
        private void PrintTestResults()
        {
            Console.WriteLine();
            Console.WriteLine("=== í…ŒìŠ¤íŠ¸ ê²°ê³¼ ===");
            Console.WriteLine($"ì´ í…ŒìŠ¤íŠ¸: {_totalTests}");
            Console.WriteLine($"í†µê³¼: {_passedTests}");
            Console.WriteLine($"ì‹¤íŒ¨: {_totalTests - _passedTests}");
            Console.WriteLine($"ì„±ê³µë¥ : {(_passedTests * 100.0 / _totalTests):F1}%");
            
            if (_testsPassed)
            {
                Console.WriteLine("ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!");
            }
            else
            {
                Console.WriteLine("ğŸ’¥ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨");
            }
            
            Console.WriteLine();
        }

        /// <summary>
        /// í…ŒìŠ¤íŠ¸ í™˜ê²½ ì •ë¦¬
        /// </summary>
        private void CleanupTestEnvironment()
        {
            try
            {
                _mapController?.Dispose();
                _webView?.Dispose();
                
                Console.WriteLine("ğŸ§¹ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì •ë¦¬ ì™„ë£Œ");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"âš ï¸ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜: {ex.Message}");
            }
        }

        /// <summary>
        /// ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        /// </summary>
        public async Task RunPerformanceTests()
        {
            Console.WriteLine("=== ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===");

            // ìœ„ì¹˜ íŒŒì‹± ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
            await TestParsingPerformance();

            // ì¢Œí‘œ ë³€í™˜ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸  
            await TestCoordinatePerformance();

            Console.WriteLine("ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ");
        }

        /// <summary>
        /// íŒŒì‹± ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
        /// </summary>
        private async Task TestParsingPerformance()
        {
            Console.WriteLine("\nâš¡ íŒŒì‹± ì„±ëŠ¥ í…ŒìŠ¤íŠ¸");
            
            var testFilename = "2024-08-27[15-30]_FactoryDay_-25.8_-18.2_5.1_0.0_-0.7_0.0_0.7 (1).png";
            var iterations = 1000;
            
            var startTime = DateTime.UtcNow;
            
            for (int i = 0; i < iterations; i++)
            {
                var result = PositionParser.ParseFromFilename(testFilename);
            }
            
            var elapsed = DateTime.UtcNow - startTime;
            var avgTime = elapsed.TotalMilliseconds / iterations;
            
            Console.WriteLine($"  {iterations}íšŒ íŒŒì‹± í‰ê·  ì‹œê°„: {avgTime:F3}ms");
            
            if (avgTime < 1.0)
            {
                Console.WriteLine("  âœ… ì„±ëŠ¥ ëª©í‘œ ë‹¬ì„± (< 1ms)");
            }
            else
            {
                Console.WriteLine("  âš ï¸ ì„±ëŠ¥ ëª©í‘œ ë¯¸ë‹¬ì„±");
            }
        }

        /// <summary>
        /// ì¢Œí‘œ ë³€í™˜ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
        /// </summary>
        private async Task TestCoordinatePerformance()
        {
            Console.WriteLine("\nâš¡ ì¢Œí‘œ ë³€í™˜ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸");
            
            var position = new Position
            {
                X = 100.0f, Z = -200.0f, Y = 10.0f,
                QuaternionX = 0.0f, QuaternionY = 0.707f,
                QuaternionZ = 0.0f, QuaternionW = 0.707f
            };
            
            var iterations = 10000;
            var startTime = DateTime.UtcNow;
            
            for (int i = 0; i < iterations; i++)
            {
                var rotation = position.Rotation; // ì¿¼í„°ë‹ˆì–¸ ê³„ì‚°
            }
            
            var elapsed = DateTime.UtcNow - startTime;
            var avgTime = elapsed.TotalMilliseconds / iterations;
            
            Console.WriteLine($"  {iterations}íšŒ ë³€í™˜ í‰ê·  ì‹œê°„: {avgTime:F4}ms");
            
            if (avgTime < 0.01)
            {
                Console.WriteLine("  âœ… ì„±ëŠ¥ ëª©í‘œ ë‹¬ì„± (< 0.01ms)");
            }
            else
            {
                Console.WriteLine("  âš ï¸ ì„±ëŠ¥ ëª©í‘œ ë¯¸ë‹¬ì„±");
            }
        }
    }
}